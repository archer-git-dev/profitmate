services:
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    volumes:
      - ./:/var/www
    ports:
      - "8080:80"
    depends_on:
      - php-fpm
      - node

  php-fpm:
    build:
      context: ./docker/php-fpm
      dockerfile: Dockerfile
    volumes:
      - ./:/var/www
    environment:
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_HTTP_PORT=8123
      - CLICKHOUSE_NATIVE_PORT=9000
      # RabbitMQ
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=user
      - RABBITMQ_PASSWORD=secret
      # MinIO (S3)
      - AWS_ACCESS_KEY_ID=fitvibe
      - AWS_SECRET_ACCESS_KEY=password123
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_BUCKET=local-bucket
      - AWS_USE_PATH_STYLE_ENDPOINT=true
      - AWS_ENDPOINT=http://minio:9000
      # Mailpit
      - MAIL_MAILER=smtp
      - MAIL_HOST=mailpit
      - MAIL_PORT=1025
    depends_on:
      - postgres
      - redis
      - clickhouse
      - rabbitmq

  php-cli:
    build:
      context: ./
      dockerfile: docker/php-cli.docker
    volumes:
      - ./:/var/www
    working_dir: /var/www
    environment:
      - DB_CONNECTION=pgsql
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_HTTP_PORT=8123
      - CLICKHOUSE_NATIVE_PORT=9000
      - COMPOSER_MEMORY_LIMIT=-1
      # RabbitMQ
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=user
      - RABBITMQ_PASSWORD=secret
      # MinIO (S3)
      - AWS_ACCESS_KEY_ID=fitvibe
      - AWS_SECRET_ACCESS_KEY=password123
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_BUCKET=local-bucket
      - AWS_USE_PATH_STYLE_ENDPOINT=true
      - AWS_ENDPOINT=http://minio:9000
      # Mailpit
      - MAIL_MAILER=smtp
      - MAIL_HOST=mailpit
      - MAIL_PORT=1025
    depends_on:
      - postgres
      - redis
      - clickhouse
    tty: true

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=fitvibe
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=secret
    ports:
      - "5432:5432"
    volumes:
      - database:/var/lib/postgresql/data

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123"   # HTTP
      - "9000:9000"   # Native TCP
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_PASSWORD=secret

  node:
    image: node:20-alpine
    ports:
      - "3000:3000"
    volumes:
      - ./:/var/www
    working_dir: /var/www
    tty: true

  redis:
    image: redis:alpine
    volumes:
      - ./docker/redis/data:/data
    ports:
      - "6379:6379"
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: fitvibe_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: secret
    ports:
      - "5672:5672"   # Ð”Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹ Ð¸Ð· PHP
      - "15672:15672" # ÐÐ´Ð¼Ð¸Ð½ÐºÐ° (http://localhost:15672)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  # 2. ðŸª£ MinIO (S3 Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº/Ð²Ð¸Ð´ÐµÐ¾)
  minio:
    image: minio/minio
    container_name: fitvibe_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: fitvibe
      MINIO_ROOT_PASSWORD: password123
    ports:
      - "9100:9000" # API S3
      - "9001:9001" # Web Console (http://localhost:9001)
    volumes:
      - minio_data:/data
  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO...' &&
      until /usr/bin/mc alias set fitvibe http://minio:9000 fitvibe password123; do
        echo '...MinIO is not ready yet, sleeping 2s...'
        sleep 2
      done &&
      /usr/bin/mc mb --ignore-existing fitvibe/local-bucket &&
      /usr/bin/mc anonymous set public fitvibe/local-bucket &&
      echo 'âœ… BUCKET CREATED AND CONFIGURED!' &&
      exit 0
      "
  mailpit:
    image: axllent/mailpit
    container_name: fitvibe_mailpit
    ports:
      - "1025:1025" # SMTP Ð¿Ð¾Ñ€Ñ‚
      - "8025:8025" # Web UI (http://localhost:8025)

volumes:
  database:
  clickhouse_data:
  rabbitmq_data:
  minio_data:
